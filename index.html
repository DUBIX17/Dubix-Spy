<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bluetooth Mic Recorder with Live Listening</title>
<style>
body { font-family: sans-serif; text-align: center; margin-top:50px; }
button { margin: 10px; padding: 10px 20px; font-size: 16px; }
audio { margin-top:20px; width: 80%; }
</style>
</head>
<body>

<h2>Bluetooth Mic Recorder + Live Listening (Gain x6)</h2>
<p>Use your earbuds as the mic and listen in real time</p>

<button id="startBtn">Start Recording</button>
<button id="stopBtn" disabled>Stop Recording</button>
<audio id="player" controls></audio>

<script>
let recorder, audioChunks = [], stream, audioCtx, source, gainNode, destination;
let folderHandle; // Handle to user-selected folder

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const player = document.getElementById("player");

// Prompt user to select a folder to save recordings
async function getFolder() {
  if (!window.showDirectoryPicker) {
    alert("Your browser does not support saving files to device folders.");
    return;
  }
  folderHandle = await window.showDirectoryPicker();
}

startBtn.onclick = async () => {
  try {
    if (!folderHandle) {
      await getFolder();
      if (!folderHandle) return;
    }

    // Get mic stream
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });

    // ----- Live listening with gain -----
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaStreamSource(stream);

    // Create GainNode and set gain x6
    gainNode = audioCtx.createGain();
    gainNode.gain.value = 30;

    destination = audioCtx.destination;
    source.connect(gainNode);
    gainNode.connect(destination);

    // ----- Recording -----
    recorder = new MediaRecorder(stream);
    recorder.ondataavailable = e => audioChunks.push(e.data);
    recorder.start();

    startBtn.disabled = true;
    stopBtn.disabled = false;
    console.log("Recording + live listening started with gain x6");
  } catch (err) {
    alert("Mic permission denied or unavailable: " + err);
  }
};

stopBtn.onclick = async () => {
  recorder.stop();
  recorder.onstop = async () => {
    const blob = new Blob(audioChunks, { type: "audio/webm" });

    // Generate filename using date and time
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, "-");
    const filename = `Recording-${timestamp}.webm`;

    // Save to folder
    const fileHandle = await folderHandle.getFileHandle(filename, { create: true });
    const writable = await fileHandle.createWritable();
    await writable.write(blob);
    await writable.close();

    // Play the saved recording
    const url = URL.createObjectURL(blob);
    player.src = url;

    // Reset
    audioChunks = [];
    stream.getTracks().forEach(track => track.stop());
    audioCtx.close();

    startBtn.disabled = false;
    stopBtn.disabled = true;
    console.log(`Recording saved as ${filename}`);
  };
};
</script>
</body>
</html>
